# 数据库配置管理机制改进计划

## 1. 当前状态分析：
系统当前使用 `src/data/db_config_manager.py`（以及 `src/db_initializer/db_config_manager.py` 中的重复副本）来管理数据库路径。
它支持"独立数据库"，但依赖于 `separate_db_paths` 配置，这是一个静态映射，将数据库名称（例如 `raw_data`、`annotation`）映射到它们的文件路径。
`output_dir` 由 `src/config/project_config_loader.py` 中的 `ProjectDataPathConfig` 管理。
`src/config/schema.py` 定义了 `ProjectDatabaseConfig`，其中包含 `db_paths` 和 `db_path`，这些已不再需要。

## 2. 提出的变更：
### 2.1. 消除单数据库设计及兼容性代码：
**操作**：从 `src/config/schema.py` 中的 `ProjectDatabaseConfig` 移除 `db_path: Optional[str] = None` 和 `db_paths: Optional[Dict[str, str]] = None`。
**操作**：从 `src/config/project_config_loader.py` 中移除任何与 `db_path` 和 `db_paths` 相关的加载/保存逻辑。
**理由**：用户明确要求"彻底放弃单数据库设计，不保留兼容性代码"。

### 2.2. 从 `output_dir` 定义"项目名称"：
**操作**：在 `src/data/db_config_manager.py` 中引入新的静态方法 `extract_project_name_from_output_dir(output_dir: str) -> str`。该方法将接受 `output_dir`（例如 `data/SocialPoemAnalysis`）并返回最后一个组件（`SocialPoemAnalysis`）。
**操作**：修改 `src/data/db_config_manager.py` 中的 `get_separate_database_paths` 函数，使其接受 `project_name: str` 作为参数。
**理由**：这直接解决了用户要求从 `output_dir` 派生组/项目名称的需求。

### 2.3. 基于项目名称的动态数据库路径生成：
**操作**：更新 `src/data/db_config_manager.py` 中的 `get_separate_database_paths`，基于 `project_name` 参数动态生成数据库路径。
路径将遵循以下约定：
- `raw_data`: `data/{project_name}/raw_data.db`
- `annotation`: `data/{project_name}/annotation.db`
- `emotion`: `data/{project_name}/emotion.db`
移除 `data/default/` 路径以及从 `config_manager.get_effective_database_config()` 读取 `separate_db_paths` 的逻辑。
**理由**：这实现了使用"项目名称"指定数据库的核心要求，并消除了对显式 `separate_db_paths` 配置的需求。

### 2.4. 模块使用"项目名称"进行数据库操作：
**操作**：`src/data/manager.py` 将成为主要接口。其构造函数或关键方法将更新为接受 `project_name: str`。
**操作**：所有需要数据库访问的其他模块（例如 `src/db_initializer/initializer.py`、`src/annotator.py`、`scripts/*`）将更新为：
- 从项目配置中获取 `output_dir`。
- 使用 `db_config_manager.extract_project_name_from_output_dir` 获取 `project_name`。
- 当初始化或执行操作时，将此 `project_name` 传递给 `src/data/manager.py`。
**理由**：这集中了数据库访问，强制执行"项目名称"抽象，并允许数据管理模块及其插件提供封装服务。

### 2.5. 重构 `src/db_initializer/db_config_manager.py`：
**操作**：删除 `src/db_initializer/db_config_manager.py`，因为它是 `src/data/db_config_manager.py` 的直接副本。
**理由**：避免代码重复并确保应用程序的一致性。

## 3. 详细实施步骤：
- **更新 `src/config/schema.py`**：
  - 从 `ProjectDatabaseConfig` 中移除 `db_paths: Optional[Dict[str, str]] = None`。
  - 从 `ProjectDatabaseConfig` 中移除 `db_path: Optional[str] = None`。
  - 如果 `config_name: str = "default"` 用于其他数据库相关设置（例如数据库类型、连接池设置等，尽管目前仅用于 `default`），则保留它。

- **更新 `src/config/project_config_loader.py`**：
  - 修改 `_load_database_config`，不再尝试加载 `db_path` 或 `db_paths`。
  - 修改 `_save_database_config`，不再保存 `db_path` 或 `db_paths`。
  - 确保在模式更改后正确处理 `ProjectDatabaseConfig`。

- **重构 `src/data/db_config_manager.py`**：
  - 添加 `extract_project_name_from_output_dir(output_dir: str) -> str` 静态方法。
  - 修改 `get_separate_database_paths(project_name: str) -> Dict[str, str]`，使用 `project_name` 动态生成路径，并移除用于路径解析的 `config_manager.get_effective_database_config()` 调用。
  - 如果不再需要 `get_database_paths` 函数，则移除它，或将其重构为使用派生的项目名称调用 `get_separate_database_paths`。
  - 更新 `ensure_database_directory_exists`，更一致地使用 `Path` 对象。

- **更新 `src/data/manager.py`**：
  - 修改 `__init__` 方法或相关数据访问方法，以接受 `project_name: str`。
  - 使用 `db_config_manager.get_separate_database_paths(project_name)` 获取数据库路径。

- **更新与数据库交互的模块**：
  - 搜索 `db_config_manager` 的使用和直接数据库路径构造。
  - 更新这些模块，使其：
    - 从 `ProjectDataPathConfig` 获取 `output_dir`。
    - 使用 `db_config_manager.extract_project_name_from_output_dir` 提取 `project_name`。
    - 将 `project_name` 传递给 `src/data/manager.py`。
  - 关键检查文件：`src/db_initializer/initializer.py`、`src/annotator.py`、`scripts/*`。

- **处理 `src/db_initializer/db_config_manager.py`**：
  - 删除此文件。

- **更新 `src/db_initializer/initializer.py`**：
  - 确保它使用新的 `db_config_manager` 和 `data/manager` 接口，并传入 `project_name`。