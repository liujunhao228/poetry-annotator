# 主项目与数据可视化子项目集成方案

## 1. 现状分析

### 1.1 主项目 (`poetry-annotator`)
- **数据库**: 单一数据库模式，默认配置为 `data/TangShi.db`。
- **配置管理**: 使用 `config/config.ini` 管理所有配置，包括数据库路径 (`[Database]` section)。
- **数据结构**: 
  - `poems` 表存储诗词内容。
  - `annotations` 表存储模型标注结果。
  - `authors` 表存储作者信息。
- **主要功能**: 负责诗词数据加载、模型调用、标注任务分发与执行。

### 1.2 数据可视化子项目 (`poetry-annotator-data-visualizer`)
- **数据库**: 多数据库支持模式，通过 `config.py` 中的 `DB_PATHS` 字典配置。
- **数据结构**:
  - 与主项目共享核心表结构 (`poems`, `annotations`, `authors`)。
  - 增加了用于高级分析的表:
    - `emotion_categories`: 存储情感分类体系。
    - `sentence_annotations`: 存储按句子拆分的标注信息。
    - `sentence_emotion_links`: 存储句子与情感的关联。
- **主要功能**: 数据分析、可视化展示、Apriori关联规则挖掘。

## 2. 集成目标与挑战

### 2.1 目标
1. **数据同步**: 确保主项目的标注结果能够无缝流入可视化子项目进行分析。
2. **配置统一**: 使两个项目能共享一套数据库配置，避免数据冗余和不一致。
3. **流程自动化**: 在主项目完成标注后，能自动或方便地触发可视化子项目的分析流程。

### 2.2 挑战
1. **数据库模式不匹配**:
   - 主项目使用单一数据库。
   - 可视化子项目使用多数据库字典。
2. **数据结构差异**:
   - 主项目仅在 `annotations` 表中存储完整JSON格式的标注结果。
   - 可视化子项目需要将这些结果进一步拆分到 `sentence_annotations` 和 `sentence_emotion_links` 表中。
3. **配置管理方式不同**:
   - 主项目使用 `config.ini` 文件。
   - 可视化子项目使用 `config.py` Python字典。

## 3. 集成方案 (已实施)

**核心思想**: 修改主项目，使其能配置并管理多个数据库，与可视化子项目对齐。

### 3.1 修改主项目配置管理器 (`src/config_manager.py`)

1.  **扩展 `get_database_config` 方法**:
    - 该方法现在能解析新的多数据库配置 `db_paths` (格式: `name1=path1,name2=path2`)。
    - 如果未配置 `db_paths`，则回退到旧的单数据库配置 `db_path`，以保证向后兼容。
2.  **更新配置验证逻辑 (`validate_config`)**:
    - 修改验证规则，使其能接受新的多数据库配置。

### 3.2 修改主项目数据管理器 (`src/data_manager.py`)

1.  **构造函数调整**:
    - `__init__` 方法现在接受一个可选的 `db_name` 参数。
    - 如果配置了 `db_paths`，则根据 `db_name` 选择对应的数据库路径。
    - 如果只配置了旧的 `db_path`，则继续使用该路径。
    - 默认情况下 (`db_name="default"`)，使用配置中的第一个数据库或旧的 `db_path`。

### 3.3 更新配置文件模板 (`config/config.ini.template`)

- 在 `[Database]` 配置节中，添加了对多数据库模式的说明和示例。
- 保留了旧的单数据库配置示例，以保证向后兼容。

### 3.4 与可视化子项目对接

- **共享数据库文件**: 两个项目可以配置为使用同一份数据库文件（例如，都指向 `data/TangShi.db`）。
- **数据初始化**: 主项目负责基础数据 (`poems`, `annotations`) 的初始化。可视化子项目的 `db_setup.py` 脚本负责创建分析所需的额外表和迁移数据。
- **操作流程**:
  1. 使用主项目进行数据初始化和标注。
  2. 运行可视化子项目的 `db_setup.py` 脚本，它会自动检测到已有的 `annotations` 数据并完成迁移。
  3. 启动可视化子项目的 Streamlit 应用进行分析。

## 4. 验证与测试

我们已经通过以下方式验证了修改的有效性：

1.  **配置解析**: 
    - 验证了 `config_manager` 能正确解析旧的单数据库配置 (`db_path`)。
    - 验证了 `config_manager` 能正确解析新的多数据库配置 (`db_paths`)。
2.  **数据管理器初始化**:
    - 验证了 `DataManager()` (默认) 能正确初始化并使用配置中的第一个数据库或旧的 `db_path`。
    - 验证了 `DataManager('SongCi')` 能正确初始化并使用指定名称的数据库。
3.  **向后兼容性**:
    - 确保了对仅配置了 `db_path` 的旧项目，其行为保持不变。

## 5. 文档更新

- 更新了 `README.md` 中的“项目配置”部分，增加了对多数据库模式的说明。
- `config.ini.template` 文件已更新，包含了详细的配置说明。

通过以上修改，主项目现在已具备与数据可视化子项目无缝集成的能力，为未来的功能扩展和数据分析工作奠定了坚实的基础。